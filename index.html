<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hospital Queue Form</title>
<link rel="stylesheet" href="styles.css">
</head>
<style>
    body {
  font-family: Arial, sans-serif;
  background-color: #f0f0f0;
  margin: 0;
  padding: 0;
}

.container {
  max-width: 400px;
  margin: 50px auto;
  background-color: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.form-group {
  margin-bottom: 20px;
}

label {
  font-weight: bold;
}

input[type="text"],
input[type="tel"],
select {
  width: calc(100% - 20px);
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin-top: 5px;
  font-size: 16px;
}

input[type="text"]:focus,
input[type="tel"]:focus,
select:focus {
  outline: none;
  border-color: #007bff;
}

small {
  display: block;
  margin-top: 5px;
  color: #666;
}

button[type="submit"] {
  display: block;
  width: 100%;
  padding: 10px;
  background-color: #007bff;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
}

button[type="submit"]:hover {
  background-color: #0056b3;
}

</style>
<body>

<div class="container">
    <div id="login-container">
      <button id="login-button">Log in with LINE</button>
    </div>
    <form id="queueForm" action="https://script.google.com/macros/s/AKfycbz4UBQsppfgiB-O3VAMDM1MyIbN_5hwqSxhLo419RHLRg5VHEZKg2Ntn75X1p-xmsijKg/exec" method="POST" style="display:none;">
      <input type="hidden" id="userId" name="userId">
      <div class="form-group">
        <label for="prefix">คำนำหน้า:</label>
        <select id="prefix" name="คำนำหน้า" required>
          <option value="">โปรดเลือก</option>
          <option value="นาย">นาย</option>
          <option value="นาง">นาง</option>
          <option value="นางสาว">นางสาว</option>
          <option value="เด็กหญิง">เด็กหญิง</option>
          <option value="เด็กชาย">เด็กชาย</option>
        </select>
      </div>
      <div class="form-group">
        <label for="fullname">ชื่อ-สกุล:</label>
        <input type="text" id="fullname" name="ชื่อ-สกุล" required>
      </div>
      <div class="form-group">
        <label for="phone">เบอร์โทรศัพท์:</label>
        <input type="tel" id="phone" name="เบอร์โทรศัพท์" pattern="[0-9]{10}" maxlength="10" required>
        <small>โปรดกรอกเบอร์โทรศัพท์ของท่าน 10 หลัก ไม่ต้องใส่ - </small>
      </div>
      <button type="submit">ส่งข้อมูล</button>
    </form>
  </div>
  
  <script>
    const form = document.getElementById('queueForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const responseData = await fetch(form.action, {
        method: 'POST',
        body: formData
      });
      const responseText = await responseData.text();
      if (responseText === 'Success') {
        alert('ข้อมูลของคุณถูกส่งเรียบร้อยแล้ว');
      } else {
        alert('มีบางอย่างผิดพลาด โปรดลองอีกครั้ง');
      }
    });

    // Function to handle LINE Login
    document.getElementById('login-button').addEventListener('click', function() {
      const lineLoginUrl = 'https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=2005198589&redirect_uri=https://itsdeax.github.io/CMH/index.html/callback&state=12345abcde&scope=profile%20openid';
      window.location.href = lineLoginUrl;
    });

    // After LINE Login, extract the user ID
    function getUserIdFromLine() {
      // Extract the ID token from the URL
      const params = new URLSearchParams(window.location.search);
      const idToken = params.get('id_token');
      if (idToken) {
        // Decode the ID token to get the user ID
        const base64Url = idToken.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        const userData = JSON.parse(jsonPayload);
        return userData.sub; // LINE user ID
      }
      return null;
    }

    // Check if user is logged in and get user ID
    const userId = getUserIdFromLine();
    if (userId) {
      document.getElementById('userId').value = userId;
      document.getElementById('login-container').style.display = 'none';
      form.style.display = 'block';
    }

  </script>

</body>
</html>
